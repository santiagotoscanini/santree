# Santree Shell Integration for Bash
# ===================================
#
# This script provides a shell wrapper around the santree CLI to enable:
# 1. Automatic directory switching after `worktree create` and `worktree switch` commands
# 2. Automatic recovery when the current worktree directory is deleted
#
# Installation:
#   Add to your .bashrc: eval "$(santree helpers shell-init bash)"
#
# How it works:
# -------------
# Since child processes cannot change the parent shell's directory, the CLI
# outputs special markers (SANTREE_CD:path) that this wrapper intercepts
# to perform the actual `cd` command in the current shell.
#
# The wrapper also handles the case where you're in a worktree directory
# that gets deleted (e.g., after `santree worktree clean` or `santree worktree remove`),
# automatically returning you to the main repository or home directory.

# Export marker so `santree doctor` can verify shell integration is loaded
export SANTREE_SHELL_INTEGRATION=1

function santree() {
    # -------------------------------------------------------------------------
    # STEP 1: Handle deleted directory recovery
    # -------------------------------------------------------------------------
    if [[ ! -d "$(pwd 2>/dev/null)" ]]; then
        local current_path="$(pwd 2>/dev/null)"

        if [[ "$current_path" == */.santree/worktrees/* ]]; then
            local main_repo="${current_path%%/.santree/worktrees/*}"
            if [[ -d "$main_repo" ]]; then
                echo "⚠ Worktree directory deleted. Returning to main repo."
                cd "$main_repo" || cd ~ || return 1
            else
                cd ~ || return 1
            fi
        else
            echo "⚠ Current directory no longer exists. Returning to home."
            cd ~ || return 1
        fi
    fi

    # -------------------------------------------------------------------------
    # STEP 2: Handle commands that need directory switching
    # -------------------------------------------------------------------------
    if [[ "$1" == "worktree" && ("$2" == "create" || "$2" == "switch") ]]; then
        local output
        output=$(command santree "$@" 2>&1)
        local exit_code=$?

        if [[ "$output" == *SANTREE_CD:* ]]; then
            echo "$output" | grep -v "SANTREE_CD:" | grep -v "SANTREE_WORK:"

            local target_dir=$(echo "$output" | sed 's/\x1b\[[0-9;]*m//g' | grep "SANTREE_CD:" | sed 's/.*SANTREE_CD://')

            if [[ -n "$target_dir" && -d "$target_dir" ]]; then
                cd "$target_dir" && echo "Switched to: $target_dir"
            fi

            if [[ "$output" == *SANTREE_WORK:* ]]; then
                local work_mode=$(echo "$output" | sed 's/\x1b\[[0-9;]*m//g' | grep "SANTREE_WORK:" | sed 's/.*SANTREE_WORK://')
                [[ "$work_mode" == "plan" ]] && command santree worktree work --plan || command santree worktree work
            fi
        else
            echo "$output"
        fi
        return $exit_code
    fi

    # -------------------------------------------------------------------------
    # STEP 3: Pass through all other commands
    # -------------------------------------------------------------------------
    command santree "$@"
}

# Aliases for convenience
alias st='santree'
alias stw='santree worktree'

# Quick create worktree with work+plan+tmux (prompts for branch)
function stn() {
    local branch
    read -p "Branch name: " branch
    [[ -z "$branch" ]] && echo "Branch name required" && return 1
    santree worktree create "$branch" --work --plan --tmux
}

# =============================================================================
# Bash Completions (auto-generated)
# =============================================================================

_santree_complete() {
    local cur prev commands
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    commands="{% for cmd in commands %}{{ cmd.name }}{% if not loop.last %} {% endif %}{% endfor %}"

    if [[ ${COMP_CWORD} -eq 1 ]]; then
        COMPREPLY=($(compgen -W "${commands}" -- "${cur}"))
        return 0
    fi

    case "${COMP_WORDS[1]}" in
{%- for cmd in commands %}
        {{ cmd.name }})
{%- if cmd.argCompletion == 'static' %}
            COMPREPLY=($(compgen -W "{{ cmd.argCompletionValues }}" -- "${cur}"))
{%- elif cmd.options.length > 0 %}
            COMPREPLY=($(compgen -W "{% for opt in cmd.options %}--{{ opt.name }}{% if not loop.last %} {% endif %}{% endfor %}" -- "${cur}"))
{%- endif %}
            ;;
{%- endfor %}
    esac
}

complete -F _santree_complete santree
complete -F _santree_complete st
